<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GabGPT Chat</title>
    <style>
        :root {
            color-scheme: dark;
            --bg:#0a0a0f;
            --bg-2:#0e0e16;
            --panel:#12121c;
            --panel-2:#171726;
            --text:#e9e9f2;
            --muted:#a5a7bf;
            --line:#1e1e2e;
            --pink:#ff2e88;
            --pink-2:#ff86c3;
            --glow: 0 0 .5rem var(--pink), 0 0 1.25rem color-mix(in oklab, var(--pink) 70%, white 0%), 0 0 2.5rem color-mix(in oklab, var(--pink) 35%, black 65%);
            --radius:16px;
            --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
            --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --danger:#ff5470;
            --success:#2cb67d;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            height: 100vh;
            font-family: var(--font);
            color: var(--text);
            background:
                radial-gradient(1200px 520px at 50% -160px, rgba(255,46,136,.12), transparent 75%),
                linear-gradient(180deg, #090914 0%, #050509 45%, #030306 75%, #020203 100%);
            background-color: #020203;
            background-repeat: no-repeat;
            background-size: 130% 70%, 100% 100%;
            background-position: center top, center top;
            background-attachment: fixed;
            line-height: 1.6;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background-image: linear-gradient(rgba(255,255,255,.03), rgba(255,255,255,0) 2px);
            background-size: 100% 3px;
            mix-blend-mode: overlay;
            opacity: .25;
        }

        @media (prefers-reduced-motion: reduce) {
            body::before { display: none; }
            * { animation: none !important; transition: none !important; }
        }

        .container {
            width: min(1000px, 92vw);
            margin-inline: auto;
        }

        header {
            background: linear-gradient(180deg, #131321, #11111c);
            border-bottom: 1px solid var(--line);
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .logo {
            font-weight: 900;
            font-size: 1.25rem;
            color: var(--text);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo .pink {
            color: var(--pink);
            text-shadow: var(--glow);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .control-group input {
            width: 60px;
            padding: 4px 8px;
            background: #0f0f1b;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            color: var(--text);
            font-size: 0.8rem;
            font-family: var(--mono);
        }

        .control-group input:focus {
            outline: none;
            border-color: var(--pink);
            box-shadow: 0 0 0 1px color-mix(in oklab, var(--pink) 50%, transparent);
        }

        .divider {
            width: 1px;
            height: 24px;
            background: var(--line);
        }

        .model-info {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.8rem;
            color: var(--muted);
        }

        .model-info .status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .model-info .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--muted);
        }

        .model-info .status-dot.loaded {
            background: var(--success);
        }

        .back-btn {
            appearance: none;
            border: 1px solid color-mix(in oklab, var(--pink) 35%, #ffffff00 65%);
            color: var(--text);
            background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
            padding: .45rem .85rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.9rem;
            transition: transform .12s ease, box-shadow .15s ease;
        }

        .back-btn:hover {
            box-shadow: var(--glow);
            transform: translateY(-1px);
        }

        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 2rem 0;
            min-height: 0;
            overflow: hidden;
        }

        .tool-article {
            background: linear-gradient(180deg, #131321, #11111c);
            border: 1px solid #222238;
            border-radius: var(--radius);
            padding: 2rem;
            box-shadow: 0 18px 50px rgba(0,0,0,.45), 0 0 60px -10px rgba(255,46,136,.15);
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .section-title {
            font-size: 0.95rem;
            margin-bottom: 18px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
        }

        .panel {
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, black 20%), var(--panel-2));
            border: 1px solid color-mix(in oklab, var(--pink) 12%, #1f1f2c 88%);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.45);
        }

        /* Loading Screen */
        .load-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 30px;
            padding: 20px;
        }

        .load-screen h2 {
            font-size: 1.5rem;
            color: var(--text);
            font-weight: 600;
            margin: 0;
        }

        .load-screen p {
            color: var(--muted);
            font-size: 0.9rem;
            text-align: center;
            max-width: 400px;
            margin: 0;
        }

        .file-loaders {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .file-loader {
            width: 200px;
            padding: 30px 20px;
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, black 20%), var(--panel-2));
            border: 2px dashed #2a2a3e;
            border-radius: 14px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .file-loader:hover {
            border-color: var(--pink);
            background: rgba(255, 46, 136, 0.05);
        }

        .file-loader.loaded {
            border-color: var(--pink);
            border-style: solid;
        }

        .file-loader input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .file-loader .icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .file-loader .label {
            font-size: 0.9rem;
            color: var(--text);
            margin-bottom: 5px;
        }

        .file-loader .hint {
            font-size: 0.75rem;
            color: var(--muted);
        }

        .file-loader .filename {
            font-size: 0.75rem;
            color: var(--success);
            margin-top: 8px;
            word-break: break-all;
        }

        .start-btn {
            padding: 12px 40px;
            background: linear-gradient(120deg, var(--pink), var(--pink-2));
            color: #050509;
            border: none;
            border-radius: 999px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
        }

        .start-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }

        .start-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .mode-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .mode-option {
            flex: 1;
            max-width: 200px;
            padding: 15px;
            background: #0f0f1b;
            border: 2px solid #2a2a3e;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: var(--pink);
        }

        .mode-option.active {
            border-color: var(--pink);
            background: rgba(255, 46, 136, 0.1);
        }

        .mode-option .mode-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .mode-option .mode-hint {
            font-size: 0.7rem;
            color: var(--muted);
        }

        /* Chat Interface */
        .chat-container {
            flex: 1;
            display: none;
            flex-direction: column;
            min-height: 0;
        }

        .chat-container.active {
            display: flex;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px 12px 20px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: color-mix(in oklab, var(--pink) 25%, #1a0e18 75%);
            border: 1px solid color-mix(in oklab, var(--pink) 55%, transparent);
            color: var(--text);
        }

        .message.assistant .avatar {
            background: var(--pink-2);
            color: #050509;
        }

        .message .content {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .message.user .content {
            background: linear-gradient(180deg, color-mix(in oklab, var(--pink) 25%, #1a0e18 75%), #1a0e18);
            border: 1px solid color-mix(in oklab, var(--pink) 55%, transparent);
            color: var(--text);
            border-bottom-right-radius: 4px;
        }

        .message.assistant .content {
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, black 20%), var(--panel-2));
            border: 1px solid color-mix(in oklab, var(--pink) 12%, #1f1f2c 88%);
            border-bottom-left-radius: 4px;
        }

        .message .content.generating {
            color: var(--muted);
        }

        .message .content.generating::after {
            content: '';
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .chat-input-container {
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
            background: linear-gradient(180deg, color-mix(in oklab, var(--panel) 80%, black 20%), var(--panel-2));
            border: 1px solid color-mix(in oklab, var(--pink) 12%, #1f1f2c 88%);
            border-radius: 14px;
            padding: 8px;
        }

        .chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text);
            font-size: 0.95rem;
            padding: 8px 12px;
            resize: none;
            font-family: inherit;
            line-height: 1.5;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--muted);
        }

        .send-btn {
            padding: 8px 20px;
            background: linear-gradient(120deg, var(--pink), var(--pink-2));
            color: #050509;
            border: none;
            border-radius: 999px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease, opacity 0.2s ease;
            align-self: flex-end;
        }

        .send-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--glow);
        }

        .send-btn:disabled {
            opacity: 0.45;
            cursor: not-allowed;
        }

        .clear-btn {
            padding: 4px 12px;
            background: none;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 999px;
            color: var(--muted);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
        }

        .hidden {
            display: none !important;
        }

        .error-message {
            background: rgba(255, 84, 112, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.85rem;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .tool-article { padding: 1.5rem; }
            nav { flex-direction: column; }
            .header-controls { flex-wrap: wrap; justify-content: center; }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <a href="index.html" class="logo">
                The Gift of <span class="pink">Gab</span>
            </a>
            <div class="header-controls">
                <div class="control-group">
                    <label>Temp:</label>
                    <input type="number" id="temperature" value="0.7" min="0.1" max="2" step="0.1">
                </div>
                <div class="control-group">
                    <label>Max tokens:</label>
                    <input type="number" id="maxTokens" value="100" min="1" max="500" step="10">
                </div>
                <div class="divider"></div>
                <div class="model-info">
                    <div class="status">
                        <span class="status-dot" id="tokenizerStatus"></span>
                        <span>Tokenizer</span>
                    </div>
                    <div class="status">
                        <span class="status-dot" id="modelStatus"></span>
                        <span>Model</span>
                    </div>
                </div>
                <button class="clear-btn" onclick="clearChat()">Clear Chat</button>
                <a href="blog_training.html" class="back-btn">Back to Blog</a>
            </div>
        </nav>
    </header>

    <main class="container">
        <article class="tool-article">
            <!-- Load Screen -->
            <div class="load-screen" id="loadScreen">
                <p style="color: var(--muted); font-size: 0.9rem;">
                    <a href="#" onclick="loadSampleModel(); return false;" style="color: var(--pink-2);">Load sample model</a>
                    or upload your own files below.
                </p>

                <div class="file-loaders">
                    <div class="file-loader" id="tokenizerLoader">
                        <input type="file" accept=".bpe" onchange="loadTokenizer(event)">
                        <div class="icon">üìù</div>
                        <div class="label">Tokenizer</div>
                        <div class="hint">.bpe file</div>
                        <div class="filename" id="tokenizerFilename"></div>
                    </div>

                    <div class="file-loader" id="modelLoader">
                        <input type="file" accept=".gab" onchange="loadModel(event)">
                        <div class="icon">üß†</div>
                        <div class="label">Model</div>
                        <div class="hint">.gab file</div>
                        <div class="filename" id="modelFilename"></div>
                    </div>
                </div>

                <div class="mode-selector">
                    <div class="mode-option active" data-mode="chat" onclick="selectMode('chat')">
                        <div class="mode-label">Chat Mode</div>
                        <div class="mode-hint">ChatML format with conversation history</div>
                    </div>
                    <div class="mode-option" data-mode="generate" onclick="selectMode('generate')">
                        <div class="mode-label">Generate Mode</div>
                        <div class="mode-hint">Raw text completion</div>
                    </div>
                </div>

                <button class="start-btn" id="startBtn" disabled onclick="startChat()">Start Chatting</button>

                <div class="error-message hidden" id="errorMessage"></div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-messages" id="chatMessages"></div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea
                            class="chat-input"
                            id="chatInput"
                            placeholder="Type your message..."
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                        ></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </article>
    </main>

    <script src="gab.js"></script>
    <script>
        class ChatApp {
            constructor() {
                this.tokenizer = null;
                this.model = null;
                this.isGenerating = false;
                this.chatLog = ''; // String-based chat log following Gab format
                this.mode = 'chat'; // 'chat' or 'generate'

                this.userTokenId = null;
                this.assistantTokenId = null;
                this.endTokenId = null;
                this.thinkTokenId = null;

                this.setupTextareaAutoResize();
            }

            // Helper: Remove trailing special tokens from string
            removeTrailingSpecialTokens(str) {
                const tokens = ['<|end|>', '<|user|>', '<|assistant|>', '<|think|>'];
                let changed = true;
                while (changed) {
                    changed = false;
                    for (const tok of tokens) {
                        if (str.endsWith(tok)) {
                            str = str.slice(0, -tok.length);
                            changed = true;
                        }
                    }
                }
                return str;
            }

            // Helper: Remove leading think/assistant/end tokens (sanitize)
            sanitizeLeadingTokens(str) {
                const tokens = ['<|think|>', '<|assistant|>', '<|end|>'];
                let changed = true;
                while (changed) {
                    changed = false;
                    for (const tok of tokens) {
                        if (str.startsWith(tok)) {
                            str = str.slice(tok.length);
                            changed = true;
                        }
                    }
                }
                return str;
            }

            // Helper: Strip all special tokens for display
            stripSpecialTokens(str) {
                return str.replace(/<\|(end|user|assistant|think)\|>/g, '');
            }

            // Prepare chat log for generation per Gab format rules
            prepareChatLogForGeneration(log, userMessage) {
                // Step 1: Sanitize - remove leading think/assistant/end tokens
                log = this.sanitizeLeadingTokens(log);

                // Step 2: Ensure user prefix
                if (!log.startsWith('<|user|>')) {
                    log = '<|user|>' + log;
                }

                // Step 3: Remove trailing special tokens
                log = this.removeTrailingSpecialTokens(log);

                // Step 4: Append new user message and suffix (always assistant, no think mode)
                log = log + '<|user|>' + userMessage + '<|assistant|>';

                return log;
            }

            setMode(mode) {
                this.mode = mode;

                // Update UI
                const options = document.querySelectorAll('.mode-option');
                for (let i = 0; i < options.length; i++) {
                    if (options[i].dataset.mode === mode) {
                        options[i].classList.add('active');
                    } else {
                        options[i].classList.remove('active');
                    }
                }
            }

            setupTextareaAutoResize() {
                const textarea = document.getElementById('chatInput');
                textarea.addEventListener('input', () => {
                    textarea.style.height = 'auto';
                    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
                });
            }

            showError(message) {
                const errorEl = document.getElementById('errorMessage');
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }

            hideError() {
                document.getElementById('errorMessage').classList.add('hidden');
            }

            loadTokenizer(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const bytes = new Uint8Array(e.target.result);
                        this.tokenizer = Tokenizer.deserialize(bytes);

                        document.getElementById('tokenizerLoader').classList.add('loaded');
                        document.getElementById('tokenizerStatus').classList.add('loaded');
                        document.getElementById('tokenizerFilename').textContent = file.name;

                        console.log('Tokenizer loaded, vocab size:', this.tokenizer.getVocabSize());
                        this.hideError();
                        this.checkReady();
                    } catch (err) {
                        this.showError('Failed to load tokenizer: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            loadModel(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const bytes = new Uint8Array(e.target.result);
                        this.model = GabGPT.deserialize(bytes);

                        document.getElementById('modelLoader').classList.add('loaded');
                        document.getElementById('modelStatus').classList.add('loaded');
                        document.getElementById('modelFilename').textContent = file.name;

                        console.log('Model loaded, vocab size:', this.model.vocabSize);
                        this.hideError();
                        this.checkReady();
                    } catch (err) {
                        this.showError('Failed to load model: ' + err.message);
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            checkReady() {
                const ready = this.tokenizer !== null && this.model !== null;
                document.getElementById('startBtn').disabled = !ready;
            }

            startChat() {
                // Try to find special tokens (only needed for chat mode)
                if (this.mode === 'chat') {
                    const specialTokens = ['<|end|>', '<|user|>', '<|assistant|>', '<|think|>'];
                    const tokenIds = [null, null, null, null];
                    for (let i = 0; i < specialTokens.length; i++) {
                        try {
                            const encoded = this.tokenizer.encode(specialTokens[i]);
                            if (encoded.length === 1) {
                                tokenIds[i] = encoded[0];
                                console.log('Found ' + specialTokens[i] + ' token:', tokenIds[i]);
                            }
                        } catch (e) {
                            console.log(specialTokens[i] + ' token not found');
                        }
                    }
                    [this.endTokenId, this.userTokenId, this.assistantTokenId, this.thinkTokenId] = tokenIds;
                }

                document.getElementById('loadScreen').classList.add('hidden');
                document.getElementById('chatContainer').classList.add('active');
                document.getElementById('chatInput').focus();

                // Update placeholder based on mode
                const input = document.getElementById('chatInput');
                if (this.mode === 'chat') {
                    input.placeholder = 'Type your message...';
                } else {
                    input.placeholder = 'Enter text to continue generating from...';
                }
            }

            addMessage(role, content, isGenerating = false) {
                const messagesEl = document.getElementById('chatMessages');

                const messageEl = document.createElement('div');
                messageEl.className = 'message ' + role;

                const avatar = role === 'user' ? 'U' : 'G';

                messageEl.innerHTML = `
                    <div class="avatar">${avatar}</div>
                    <div class="content ${isGenerating ? 'generating' : ''}">${this.escapeHtml(content)}</div>
                `;

                messagesEl.appendChild(messageEl);
                messagesEl.scrollTop = messagesEl.scrollHeight;

                return messageEl;
            }

            updateMessage(messageEl, content, isGenerating = false) {
                const contentEl = messageEl.querySelector('.content');
                contentEl.textContent = content;
                if (isGenerating) {
                    contentEl.classList.add('generating');
                } else {
                    contentEl.classList.remove('generating');
                }

                const messagesEl = document.getElementById('chatMessages');
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            async sendMessage() {
                if (this.isGenerating) return;

                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                if (!message) return;

                input.value = '';
                input.style.height = 'auto';

                this.addMessage('user', message);

                if (this.mode === 'chat') {
                    // Chat mode: use Gab format
                    await this.generate(true, message);
                } else {
                    // Generate mode: raw text completion
                    await this.generate(false, message);
                }
            }

            async generate(isChatMode, userMessage) {
                this.isGenerating = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('chatInput').disabled = true;

                const messageEl = this.addMessage('assistant', '', true);

                const temperature = parseFloat(document.getElementById('temperature').value) || 0.7;
                const maxTokens = parseInt(document.getElementById('maxTokens').value) || 100;

                let tokens;
                if (isChatMode) {
                    // Prepare chat log following Gab format rules
                    let preparedLog;
                    if (this.chatLog === '') {
                        // First message - just user + assistant suffix
                        preparedLog = '<|user|>' + userMessage + '<|assistant|>';
                    } else {
                        preparedLog = this.prepareChatLogForGeneration(this.chatLog, userMessage);
                    }
                    tokens = this.tokenizer.encode(preparedLog);

                    // Trim from beginning if too long (preserve recent context)
                    const maxContext = this.model.embedding.maxSequenceLength - 100;
                    if (tokens.length > maxContext) {
                        tokens = tokens.slice(-maxContext);
                    }
                } else {
                    // Generate mode: raw text completion
                    tokens = this.tokenizer.encode(userMessage);
                }

                let generated = [];
                let responseText = '';

                try {
                    for (let i = 0; i < maxTokens; i++) {
                        // Truncate if exceeding max sequence length
                        const maxSeqLen = this.model.embedding.maxSequenceLength;
                        let inputTokens = tokens;
                        if (tokens.length > maxSeqLen) {
                            inputTokens = tokens.slice(-maxSeqLen);
                        }

                        // Forward pass
                        const batchedInput = [inputTokens];
                        const probs = this.model.forward(batchedInput);
                        const lastProbs = probs[0][inputTokens.length - 1];

                        // Sample with temperature
                        const nextToken = this.sampleWithTemperature(lastProbs, temperature);

                        // Check for end token (only in chat mode)
                        if (isChatMode && this.endTokenId !== null && nextToken === this.endTokenId) {
                            break;
                        }

                        tokens.push(nextToken);
                        generated.push(nextToken);

                        // Decode and update display
                        responseText = this.tokenizer.decode(generated);

                        // Remove special tokens from display (only in chat mode)
                        if (isChatMode) {
                            responseText = this.stripSpecialTokens(responseText);
                        }

                        this.updateMessage(messageEl, responseText, true);

                        // Yield to UI
                        await new Promise(resolve => setTimeout(resolve, 0));
                    }

                    // Final update
                    this.updateMessage(messageEl, responseText || '(empty response)', false);

                    // Update chat log (only in chat mode)
                    if (isChatMode) {
                        // Post-generation: update chat log
                        // Format: previous log + user message + assistant response + <|end|>
                        // Then append <|user|> to prepare for next message
                        if (this.chatLog === '') {
                            this.chatLog = '<|user|>' + userMessage + '<|assistant|>' + this.tokenizer.decode(generated) + '<|end|><|user|>';
                        } else {
                            this.chatLog = this.removeTrailingSpecialTokens(this.chatLog) + '<|user|>' + userMessage + '<|assistant|>' + this.tokenizer.decode(generated) + '<|end|><|user|>';
                        }
                    }
                    // In generate mode, don't accumulate history

                } catch (err) {
                    console.error('Generation error:', err);
                    this.updateMessage(messageEl, 'Error: ' + err.message, false);
                }

                this.isGenerating = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('chatInput').disabled = false;
                document.getElementById('chatInput').focus();
            }

            sampleWithTemperature(probs, temperature) {
                // Convert probabilities to logits
                const logits = [];
                for (let i = 0; i < probs.length; i++) {
                    logits.push(Math.log(probs[i] + 1e-10));
                }

                // Apply temperature
                const scaledLogits = [];
                for (let i = 0; i < logits.length; i++) {
                    scaledLogits.push(logits[i] / temperature);
                }

                // Softmax
                let maxLogit = scaledLogits[0];
                for (let i = 1; i < scaledLogits.length; i++) {
                    if (scaledLogits[i] > maxLogit) {
                        maxLogit = scaledLogits[i];
                    }
                }

                const expLogits = [];
                let sum = 0;
                for (let i = 0; i < scaledLogits.length; i++) {
                    const exp = Math.exp(scaledLogits[i] - maxLogit);
                    expLogits.push(exp);
                    sum += exp;
                }

                const scaledProbs = [];
                for (let i = 0; i < expLogits.length; i++) {
                    scaledProbs.push(expLogits[i] / sum);
                }

                // Sample
                const random = Math.random();
                let cumulative = 0;
                for (let i = 0; i < scaledProbs.length; i++) {
                    cumulative += scaledProbs[i];
                    if (random < cumulative) {
                        return i;
                    }
                }

                return scaledProbs.length - 1;
            }

            clearChat() {
                document.getElementById('chatMessages').innerHTML = '';
                this.chatLog = '';
            }
        }

        // Global instance
        let app;

        document.addEventListener('DOMContentLoaded', () => {
            app = new ChatApp();
        });

        function loadTokenizer(event) {
            const file = event.target.files[0];
            if (file) {
                app.loadTokenizer(file);
            }
        }

        function loadModel(event) {
            const file = event.target.files[0];
            if (file) {
                app.loadModel(file);
            }
        }

        function startChat() {
            app.startChat();
        }

        function selectMode(mode) {
            app.setMode(mode);
        }

        function sendMessage() {
            app.sendMessage();
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function clearChat() {
            app.clearChat();
        }

        async function loadSampleModel() {
            const link = event.target;
            const originalText = link.textContent;
            link.textContent = 'Loading...';
            link.style.pointerEvents = 'none';

            try {
                // Fetch both files in parallel
                const [modelResponse, tokenizerResponse] = await Promise.all([
                    fetch('model.gab'),
                    fetch('model.bpe')
                ]);

                if (!modelResponse.ok) {
                    throw new Error('Failed to fetch model.gab: ' + modelResponse.status);
                }
                if (!tokenizerResponse.ok) {
                    throw new Error('Failed to fetch model.bpe: ' + tokenizerResponse.status);
                }

                const [modelBuffer, tokenizerBuffer] = await Promise.all([
                    modelResponse.arrayBuffer(),
                    tokenizerResponse.arrayBuffer()
                ]);

                // Load tokenizer
                const tokenizerBytes = new Uint8Array(tokenizerBuffer);
                app.tokenizer = Tokenizer.deserialize(tokenizerBytes);
                document.getElementById('tokenizerLoader').classList.add('loaded');
                document.getElementById('tokenizerStatus').classList.add('loaded');
                document.getElementById('tokenizerFilename').textContent = 'model.bpe';
                console.log('Tokenizer loaded, vocab size:', app.tokenizer.getVocabSize());

                // Load model
                const modelBytes = new Uint8Array(modelBuffer);
                app.model = GabGPT.deserialize(modelBytes);
                document.getElementById('modelLoader').classList.add('loaded');
                document.getElementById('modelStatus').classList.add('loaded');
                document.getElementById('modelFilename').textContent = 'model.gab';
                console.log('Model loaded, vocab size:', app.model.vocabSize);

                app.hideError();
                app.checkReady();

            } catch (err) {
                app.showError('Failed to load sample model: ' + err.message);
                link.textContent = originalText;
                link.style.pointerEvents = '';
            }
        }
    </script>
</body>
</html>
